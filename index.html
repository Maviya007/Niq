<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>NIQ Enterprise Customer Experience Platform</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

<style>
/* ================= NIQ ENTERPRISE DESIGN SYSTEM ================= */
:root {
  --niq-blue: #003a8f;
  --niq-blue-2: #2c7be5;
  --niq-dark: #0f2a44;
  --niq-bg: #f4f7fa;
  --niq-white: #ffffff;
  --niq-border: rgba(0,58,143,0.18);
  --niq-muted: #6b7280;
  --niq-shadow: rgba(0,58,143,0.12);
  --niq-glass: rgba(255,255,255,0.35);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Inter', sans-serif;
  background: var(--niq-bg);
  color: var(--niq-dark);
  min-height: 100vh;
  overflow-x: hidden;
}

/* ================= BACKGROUND ================= */
.background-layer {
  position: fixed;
  inset: 0;
  z-index: 0;
  background: linear-gradient(180deg, #ffffff 0%, #f4f7fa 100%);
}
.background-layer::before {
  content: "";
  position: absolute;
  inset: 0;
  background-image:
    linear-gradient(transparent 95%, rgba(0,58,143,0.04) 95%),
    linear-gradient(90deg, transparent 95%, rgba(0,58,143,0.04) 95%);
  background-size: 64px 64px;
}

.bubble {
  position: absolute;
  border-radius: 50%;
  opacity: 0.06;
  animation: float linear infinite;
}
.bubble.dark { background: var(--niq-blue); }
.bubble.light { background: var(--niq-blue-2); }

@keyframes float {
  0% { transform: translateY(120vh) translateX(0) rotate(0deg); }
  100% { transform: translateY(-130vh) translateX(120px) rotate(360deg); }
}

/* ================= LAYOUT ================= */
.app-layout {
  position: relative;
  z-index: 1;
  display: grid;
  grid-template-columns: 260px 1fr 340px;
  min-height: 100vh;
}

.brand-panel {
  background: linear-gradient(180deg, var(--niq-dark), var(--niq-blue));
  color: white;
  padding: 2rem 1.6rem;
  display: flex;
  flex-direction: column;
  border-right: 2px solid var(--niq-border);
}
.brand-logo { font-size: 2.4rem; font-weight: 800; letter-spacing: -1.5px; margin-bottom: 2rem; }
.brand-title { font-size: 1.15rem; font-weight: 600; margin-bottom: 0.5rem; }
.brand-subtitle { font-size: 0.92rem; opacity: 0.75; line-height: 1.5; }
.brand-footer { margin-top: auto; font-size: 0.8rem; opacity: 0.6; }

.survey-panel { padding: 3rem 3.2rem; display: flex; flex-direction: column; }

.survey-card {
  background: var(--niq-glass);
  backdrop-filter: blur(25px);
  border: 2px solid var(--niq-border);
  box-shadow: 0 28px 70px var(--niq-shadow);
  padding: 2.6rem 2.8rem;
  border-radius: 16px;
}

.survey-title { font-size: 2rem; font-weight: 700; margin-bottom: 0.3rem; }
.survey-desc { font-size: 1rem; color: var(--niq-muted); }

/* ================= PROGRESS ================= */
.progress-wrap { margin: 1.4rem 0 2rem; }
.progress-bar { 
  height: 6px; 
  background: rgba(0,58,143,0.12);
  border-radius: 3px;
}
.progress-fill { 
  height: 100%; 
  width: 25%; 
  background: linear-gradient(90deg, var(--niq-blue), var(--niq-blue-2)); 
  transition: width 0.4s ease;
  border-radius: 3px;
}
.progress-steps { display: flex; justify-content: space-between; font-size: 0.8rem; margin-top: 0.6rem; color: var(--niq-muted); }

.step { display: none; }
.step.active { display: block; }

/* ================= RATING SCALE DESCRIPTION ================= */
.rating-guide {
  background: rgba(0,58,143,0.08);
  backdrop-filter: blur(12px);
  border: 2px solid var(--niq-border);
  padding: 1rem 1.4rem;
  margin-bottom: 2.5rem;
  border-radius: 8px;
  text-align: center;
}

.rating-guide-text {
  font-size: 0.95rem;
  color: var(--niq-dark);
  font-weight: 600;
}

/* ================= SECTION DIVIDER ================= */
.section-divider {
  margin: 2.5rem 0 2rem;
  padding-top: 2rem;
  border-top: 2px solid var(--niq-border);
}

.section-title {
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--niq-blue);
  margin-bottom: 0.4rem;
}

.section-desc {
  font-size: 0.9rem;
  color: var(--niq-muted);
  margin-bottom: 1.5rem;
}

/* ================= QUESTION BOX ================= */
.question-box {
  background: rgba(255,255,255,0.25);
  backdrop-filter: blur(20px);
  border: 2px solid var(--niq-border);
  padding: 2rem 2.2rem;
  margin-bottom: 1.5rem;
  border-radius: 12px;
  transition: all 0.3s ease;
  box-shadow: 0 8px 30px rgba(0,58,143,0.06);
}

.question-box:hover {
  background: rgba(255,255,255,0.35);
  box-shadow: 0 12px 40px rgba(0,58,143,0.1);
  transform: translateY(-2px);
}

.question-title { 
  font-size: 1.1rem; 
  font-weight: 600; 
  margin-bottom: 1.3rem;
  color: var(--niq-dark);
}

/* ================= NPS SCALE ================= */
.nps-scale { 
  display: grid; 
  grid-template-columns: repeat(11, 1fr); 
  gap: 0.5rem;
}

.nps-item {
  padding: 0.75rem 0;
  text-align: center;
  border: 2px solid var(--niq-blue);
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 0.9rem;
  font-weight: 700;
  background: rgba(255,255,255,0.8);
  backdrop-filter: blur(10px);
  border-radius: 6px;
}

.nps-item:hover { 
  background: #e6f0ff; 
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(0,58,143,0.15);
}

.nps-item.selected { 
  background: var(--niq-blue); 
  color: white; 
  box-shadow: 0 6px 20px rgba(0,58,143,0.3);
  transform: translateY(-2px);
}

/* ================= TEXTAREA ================= */
.textarea {
  width: 100%;
  min-height: 140px;
  border: 2px solid var(--niq-border);
  padding: 1rem;
  font-family: inherit;
  font-size: 0.95rem;
  resize: none;
  transition: 0.2s ease;
  border-radius: 8px;
  background: rgba(255,255,255,0.7);
  backdrop-filter: blur(10px);
}
.textarea:focus { 
  outline: none; 
  border-color: var(--niq-blue); 
  background: rgba(255,255,255,0.9);
  box-shadow: 0 4px 20px rgba(0,58,143,0.12);
}

/* ================= BUTTONS ================= */
.nav-buttons { 
  display: flex; 
  justify-content: space-between; 
  margin-top: 2rem;
}

.btn {
  padding: 0.9rem 2rem;
  border: 2px solid var(--niq-blue);
  background: rgba(255,255,255,0.8);
  backdrop-filter: blur(10px);
  font-weight: 700;
  cursor: pointer;
  transition: 0.2s ease;
  border-radius: 8px;
  font-size: 0.95rem;
}

.btn.primary { 
  background: linear-gradient(135deg, var(--niq-blue), var(--niq-blue-2)); 
  color: white;
}

.btn:hover { 
  transform: translateY(-2px); 
  box-shadow: 0 6px 20px rgba(0,58,143,0.2); 
}

.btn:disabled { 
  opacity: 0.5; 
  cursor: not-allowed;
  transform: none;
}

/* ================= ANALYTICS PANEL ================= */
.analytics-panel {
  background: rgba(249,251,255,0.6);
  backdrop-filter: blur(25px);
  border-left: 2px solid var(--niq-border);
  padding: 2.2rem 2rem;
}
.analytics-title { font-size: 1.15rem; font-weight: 700; margin-bottom: 1.3rem; }
.metric { 
  margin-bottom: 1.4rem; 
  background: rgba(255,255,255,0.4);
  backdrop-filter: blur(15px);
  padding: 1.2rem;
  border-radius: 8px;
  border: 2px solid var(--niq-border);
}
.metric-label { font-size: 0.85rem; color: var(--niq-muted); }
.metric-value { font-size: 1.7rem; font-weight: 700; margin-top: 0.2rem; }

/* ================= SUCCESS SCREEN ================= */
.success-screen {
  text-align: center;
  padding: 3rem 2rem;
}

/* ================= WHEEL MODAL ================= */
.wheel-overlay {
  position: fixed;
  inset: 0;
  background: rgba(15,42,68,0.65);
  backdrop-filter: blur(6px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 999;
}
.wheel-overlay.active { display: flex; }

.wheel-modal {
  width: 680px;
  background: rgba(255,255,255,0.5);
  backdrop-filter: blur(25px);
  border: 2px solid var(--niq-border);
  box-shadow: 0 30px 80px var(--niq-shadow);
  padding: 2rem 2.4rem;
  text-align: center;
  border-radius: 12px;
}
.wheel-title { font-size: 1.4rem; font-weight: 700; margin-bottom: 0.4rem; }
.wheel-subtitle { font-size: 0.9rem; color: var(--niq-muted); margin-bottom: 1.4rem; }

.wrapper {
  position: relative;
  width: 420px;
  height: 420px;
  padding: 10px;
  background: white;
  border-radius: 50%;
  box-shadow: 0 20px 50px rgba(0,58,143,0.18);
  margin: 0 auto 1.2rem;
}

.pointer {
  position: absolute;
  top: -8px;
  left: 50%;
  transform: translateX(-50%);
  width: 36px;
  height: 46px;
  z-index: 30;
}
.pointer svg { fill: #ff4d4f; }

canvas { width: 100%; height: 100%; }

.center-hub {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 82px;
  height: 82px;
  border-radius: 50%;
  background: white;
  border: 5px solid var(--niq-blue);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  color: var(--niq-blue);
  font-size: 22px;
  z-index: 20;
}

.wheel-btn {
  padding: 0.8rem 2.2rem;
  border: 2px solid var(--niq-blue);
  background: white;
  font-weight: 700;
  cursor: pointer;
  transition: 0.2s ease;
  border-radius: 6px;
}
.wheel-btn.primary { background: linear-gradient(135deg, var(--niq-blue), var(--niq-blue-2)); color: white; }
.wheel-result { margin-top: 0.8rem; font-weight: 700; color: var(--niq-blue); font-size: 1.2rem; }

.already-spun {
  font-size: 1.1rem;
  color: var(--niq-muted);
  margin-top: 1rem;
}

@media (max-width: 1100px) {
  .app-layout { grid-template-columns: 220px 1fr; }
  .analytics-panel { display: none; }
}
@media (max-width: 700px) {
  .app-layout { grid-template-columns: 1fr; }
  .brand-panel { display: none; }
  .survey-panel { padding: 1.5rem; }
  .survey-card { padding: 1.8rem; }
  .wheel-modal { width: 92%; }
  .wrapper { width: 320px; height: 320px; }
  .nps-scale { grid-template-columns: repeat(6, 1fr); }
}
</style>
</head>
<body>

<div class="background-layer">
  <!-- Enhanced floating bubbles - More bubbles added -->
  <div class="bubble dark" style="width:120px;height:120px;left:5%;animation-duration:28s;"></div>
  <div class="bubble light" style="width:90px;height:90px;left:12%;animation-duration:35s;animation-delay:-5s;"></div>
  <div class="bubble dark" style="width:70px;height:70px;left:20%;animation-duration:24s;animation-delay:-10s;"></div>
  <div class="bubble light" style="width:110px;height:110px;left:28%;animation-duration:32s;"></div>
  <div class="bubble dark" style="width:85px;height:85px;left:35%;animation-duration:26s;animation-delay:-8s;"></div>
  <div class="bubble light" style="width:100px;height:100px;left:42%;animation-duration:30s;animation-delay:-3s;"></div>
  <div class="bubble dark" style="width:130px;height:130px;left:50%;animation-duration:38s;animation-delay:-12s;"></div>
  <div class="bubble light" style="width:75px;height:75px;left:58%;animation-duration:22s;animation-delay:-6s;"></div>
  <div class="bubble dark" style="width:95px;height:95px;left:65%;animation-duration:30s;"></div>
  <div class="bubble light" style="width:115px;height:115px;left:72%;animation-duration:34s;animation-delay:-9s;"></div>
  <div class="bubble dark" style="width:80px;height:80px;left:79%;animation-duration:27s;animation-delay:-15s;"></div>
  <div class="bubble light" style="width:105px;height:105px;left:86%;animation-duration:33s;animation-delay:-7s;"></div>
  <div class="bubble dark" style="width:65px;height:65px;left:93%;animation-duration:25s;animation-delay:-11s;"></div>
  <div class="bubble light" style="width:90px;height:90px;left:10%;animation-duration:29s;animation-delay:-4s;"></div>
  <div class="bubble dark" style="width:100px;height:100px;left:45%;animation-duration:31s;animation-delay:-13s;"></div>
  <div class="bubble light" style="width:70px;height:70px;left:67%;animation-duration:23s;animation-delay:-8s;"></div>
  <div class="bubble dark" style="width:85px;height:85px;left:82%;animation-duration:28s;animation-delay:-16s;"></div>
  <div class="bubble light" style="width:95px;height:95px;left:15%;animation-duration:32s;animation-delay:-2s;"></div>
</div>

<div class="app-layout">

  <aside class="brand-panel">
    <div class="brand-logo">NIQ</div>
    <div class="brand-title">Customer Experience</div>
    <div class="brand-subtitle">Enterprise feedback platform designed to improve service quality and decision-making.</div>
    <div class="brand-footer">NIQ Internal Systems</div>
  </aside>

  <main class="survey-panel">
    <div class="survey-card">

      <div class="survey-header">
        <div class="survey-title">Service Feedback Survey</div>
        <div class="survey-desc">Your feedback helps NIQ improve support quality and operational excellence.</div>
      </div>

      <div class="progress-wrap">
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        <div class="progress-steps">
          <span>Ratings</span><span>Feedback</span><span>Submit</span>
        </div>
      </div>

      <div class="step active" data-step="1">
        
        <div class="rating-guide">
          <div class="rating-guide-text">Rating Scale: 0 = Poor, 10 = Excellent</div>
        </div>

        <div class="section-divider">
          <div class="section-title">Service Quality Assessment</div>
          <div class="section-desc">Rate your experience across key service dimensions</div>
        </div>

        <div class="question-box">
          <div class="question-title">Overall Experience</div>
          <div class="nps-scale" data-question="overall"></div>
        </div>

        <div class="question-box">
          <div class="question-title">Communication Quality</div>
          <div class="nps-scale" data-question="communication"></div>
        </div>

        <div class="question-box">
          <div class="question-title">Solution Accuracy</div>
          <div class="nps-scale" data-question="accuracy"></div>
        </div>

        <div class="question-box">
          <div class="question-title">Response Time</div>
          <div class="nps-scale" data-question="response"></div>
        </div>

        <div class="question-box">
          <div class="question-title">Technical Expertise</div>
          <div class="nps-scale" data-question="expertise"></div>
        </div>

        <div class="question-box">
          <div class="question-title">Professional Courtesy</div>
          <div class="nps-scale" data-question="courtesy"></div>
        </div>

      </div>

      <div class="step" data-step="2">
        <div class="question-box">
          <div class="question-title">Additional Feedback</div>
          <textarea class="textarea" id="textFeedback" placeholder="Share suggestions or issues to help us improve..."></textarea>
        </div>
      </div>

      <div class="step" data-step="3">
        <div class="success-screen">
          <div class="survey-title" style="color:var(--niq-blue)">Feedback Submitted</div>
          <div class="survey-desc">Thank you for contributing to NIQ service excellence.</div>
        </div>
      </div>

      <div class="nav-buttons">
        <button class="btn" id="prevBtn" disabled>Back</button>
        <button class="btn primary" id="nextBtn">Next</button>
      </div>

    </div>
  </main>

  <aside class="analytics-panel">
    <div class="analytics-title">Live Metrics</div>
    <div class="metric">
      <div class="metric-label">Average Score</div>
      <div class="metric-value" id="metricExp">-</div>
    </div>
    <div class="metric">
      <div class="metric-label">Completed</div>
      <div class="metric-value" id="metricCompleted">0/6</div>
    </div>
    <div class="metric">
      <div class="metric-label">Reward Points</div>
      <div class="metric-value" id="metricPoints">0</div>
    </div>
  </aside>

</div>

<div class="wheel-overlay" id="wheelOverlay">
  <div class="wheel-modal">
    <div class="wheel-title">NIQ Engagement Wheel</div>
    <div class="wheel-subtitle" id="wheelSubtitle">One spin only â€¢ Earn reward points</div>

    <div class="wrapper" id="wheelWrapper">
      <div class="pointer">
        <svg viewBox="0 0 40 50"><path d="M20 50 L40 0 L0 0 Z"/></svg>
      </div>
      <canvas id="wheel" width="500" height="500"></canvas>
      <div class="center-hub">NIQ</div>
    </div>

    <button class="wheel-btn primary" id="spinBtn">SPIN WHEEL</button>
    <div class="wheel-result" id="result"></div>
    <div class="already-spun" id="alreadySpun" style="display:none;">You have already claimed your reward!</div>
  </div>
</div>

<script>
const state = { ratings: {}, text: "" };
let currentStep = 1;
const totalSteps = 3;
let hasSubmitted = false; // Track if survey has been submitted in this session

const progressFill = document.getElementById('progressFill');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');

/* ===== CHECK IF WHEEL ALREADY SPUN ===== */
function hasSpunWheel() {
  return localStorage.getItem('niq_wheel_spun') === 'true';
}

function markWheelAsSpun() {
  localStorage.setItem('niq_wheel_spun', 'true');
}

/* ===== LOAD SAVED POINTS ON PAGE LOAD ===== */
window.addEventListener('DOMContentLoaded', () => {
  const savedPoints = localStorage.getItem('niq_points') || '0';
  document.getElementById('metricPoints').textContent = savedPoints;
});

/* ===== CREATE ALL RATING SCALES ===== */
document.querySelectorAll('.nps-scale[data-question]').forEach(scale => {
  for (let i = 0; i <= 10; i++) {
    const div = document.createElement('div');
    div.className = 'nps-item';
    div.textContent = i;
    div.onclick = () => {
      scale.querySelectorAll('.nps-item').forEach(el => el.classList.remove('selected'));
      div.classList.add('selected');
      state.ratings[scale.dataset.question] = i;
      updateMetrics();
    };
    scale.appendChild(div);
  }
});

/* ===== STEP NAVIGATION ===== */
function showStep(step) {
  document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
  document.querySelector(`.step[data-step="${step}"]`).classList.add('active');
  progressFill.style.width = ((step - 1) / (totalSteps - 1)) * 100 + '%';
  prevBtn.disabled = step === 1;
  nextBtn.textContent = step === totalSteps ? 'Finish' : 'Next';
}

prevBtn.onclick = () => {
  if (currentStep > 1) { currentStep--; showStep(currentStep); }
};

nextBtn.onclick = () => {
  if (currentStep === 1 && Object.keys(state.ratings).length < 6) {
    alert('Please rate all categories');
    return;
  }
  
  if (currentStep === 2) state.text = document.getElementById('textFeedback').value;

  if (currentStep < totalSteps) {
    currentStep++;
    showStep(currentStep);
  }

  // Only open wheel on first submission
  if (currentStep === totalSteps && !hasSubmitted) {
    hasSubmitted = true;
    setTimeout(openWheel, 1200);
  }
};

function updateMetrics() {
  const values = Object.values(state.ratings);
  const avg = values.reduce((a,b)=>a+b,0) / (values.length || 1);
  document.getElementById('metricExp').textContent = values.length > 0 ? avg.toFixed(1) : '-';
  document.getElementById('metricCompleted').textContent = `${values.length}/6`;
}

showStep(currentStep);

/* ===== WHEEL ENGINE ===== */
const wheelOverlay = document.getElementById('wheelOverlay');
const canvas = document.getElementById('wheel');
const ctx = canvas.getContext('2d');
const spinBtn = document.getElementById('spinBtn');
const resultBox = document.getElementById('result');
const alreadySpunMsg = document.getElementById('alreadySpun');
const wheelSubtitle = document.getElementById('wheelSubtitle');
const wheelWrapper = document.getElementById('wheelWrapper');

const items = [
  "150 Points", "650 Points", "350 Points", "450 Points",
  "550 Points", "250 Points", "800 Points", "Better Luck"
];

const colors = ["#003a8f", "#f0f5ff", "#2c7be5", "#ffffff", "#002766", "#f0f5ff", "#096dd9", "#ffffff"];

let currentAngle = 0;
let isSpinning = false;
let lastTickIndex = -1;

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playTick() {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = "sine";
  osc.frequency.setValueAtTime(400, audioCtx.currentTime);
  gain.gain.setValueAtTime(0.03, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.08);
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + 0.08);
}

function playWin() {
  const notes = [
    { freq: 440, time: 0, duration: 0.15 },
    { freq: 554.37, time: 0.12, duration: 0.15 },
    { freq: 659.25, time: 0.24, duration: 0.25 }
  ];
  
  notes.forEach(note => {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = "sine";
    osc.frequency.setValueAtTime(note.freq, audioCtx.currentTime + note.time);
    gain.gain.setValueAtTime(0.08, audioCtx.currentTime + note.time);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + note.time + note.duration);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start(audioCtx.currentTime + note.time);
    osc.stop(audioCtx.currentTime + note.time + note.duration);
  });
}

function drawWheel() {
  const radius = canvas.width / 2;
  const slice = (2 * Math.PI) / items.length;
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  items.forEach((item, i) => {
    const angle = currentAngle + i * slice;
    ctx.beginPath();
    ctx.moveTo(radius, radius);
    ctx.arc(radius, radius, radius - 10, angle, angle + slice);
    ctx.fillStyle = colors[i];
    ctx.fill();
    ctx.strokeStyle = "rgba(255,255,255,0.2)";
    ctx.lineWidth = 1;
    ctx.stroke();

    ctx.save();
    ctx.translate(radius, radius);
    ctx.rotate(angle + slice / 2);
    ctx.textAlign = "right";
    ctx.fillStyle = i % 2 === 0 ? "white" : "#003a8f";
    ctx.font = "bold 15px Inter";
    ctx.fillText(item, radius - 40, 6);
    ctx.restore();
  });
}

drawWheel();

function openWheel() {
  // Check if already spun
  if (hasSpunWheel()) {
    // Show already claimed message
    wheelSubtitle.style.display = 'none';
    wheelWrapper.style.opacity = '0.5';
    spinBtn.style.display = 'none';
    alreadySpunMsg.style.display = 'block';
    
    const savedPoints = localStorage.getItem('niq_points') || '0';
    resultBox.textContent = `Your Total: ${savedPoints} Points`;
    resultBox.style.display = 'block';
  } else {
    // Reset for new spin
    wheelSubtitle.style.display = 'block';
    wheelWrapper.style.opacity = '1';
    spinBtn.style.display = 'inline-block';
    spinBtn.disabled = false;
    alreadySpunMsg.style.display = 'none';
    resultBox.textContent = '';
  }
  
  wheelOverlay.classList.add('active');
}

spinBtn.addEventListener("click", () => {
  if (isSpinning || hasSpunWheel()) return;
  if (audioCtx.state === 'suspended') audioCtx.resume();

  isSpinning = true;
  spinBtn.disabled = true;
  resultBox.textContent = "SPINNING...";

  const spinDuration = 5000;
  const startAngle = currentAngle;
  const totalSpins = (Math.PI * 2 * 9) + (Math.random() * Math.PI * 2);
  const startTime = performance.now();

  function animate(now) {
    const p = Math.min((now - startTime) / spinDuration, 1);
    const ease = 1 - Math.pow(1 - p, 3);
    currentAngle = startAngle + totalSpins * ease;

    const slice = (2 * Math.PI) / items.length;
    const currentTick = Math.floor((currentAngle % (Math.PI * 2)) / slice);
    if (currentTick !== lastTickIndex) {
      playTick();
      lastTickIndex = currentTick;
    }

    drawWheel();

    if (p < 1) requestAnimationFrame(animate);
    else finalize();
  }
  requestAnimationFrame(animate);
});

function finalize() {
  isSpinning = false;

  const slice = (2 * Math.PI) / items.length;
  const winningIndex = items.length - 1 - Math.floor(((currentAngle + Math.PI/2) % (Math.PI * 2)) / slice);
  const result = items[winningIndex >= 0 ? winningIndex : 0];

  resultBox.textContent = result.toUpperCase();

  let earned = 0;
  if (!result.includes("Try") && !result.includes("Luck")) {
    earned = parseInt(result);
    playWin();
  }

  let totalPoints = parseInt(localStorage.getItem('niq_points') || '0');
  totalPoints += earned;
  localStorage.setItem('niq_points', totalPoints);
  document.getElementById('metricPoints').textContent = totalPoints;

  // Mark wheel as spun (ONE TIME ONLY)
  markWheelAsSpun();

  // Hide spin button after first spin
  setTimeout(() => {
    spinBtn.style.display = 'none';
    wheelSubtitle.textContent = 'Reward Claimed!';
  }, 2000);

  setTimeout(() => {
    wheelOverlay.classList.remove('active');
  }, 3500);
}

// Close wheel overlay when clicking outside
wheelOverlay.addEventListener('click', (e) => {
  if (e.target === wheelOverlay) {
    wheelOverlay.classList.remove('active');
  }
});
</script>
</body>
</html>
